<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Open CASCADE Technology: OCAF: Function Mechanism</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
  /* @license-end */
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Open CASCADE Technology"/>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="occ_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Open CASCADE Technology
   &#160;<span id="projectnumber">7.8.0</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.php" method="get">
              <img id="MSearchSelect" src="search/mag.png" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('samples__ocaf_func.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">OCAF: Function Mechanism </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Let us describe the usage of the "Function Mechanism" of Open CASCADE Application Framework on a simple example. <br  />
 This example represents a "nail" composed by a cone and two cylinders of different radius and height: <br  />
</p>
<div class="image">
<img src="ocaf_functionmechanism_wp_image003.png" alt=""/>
<div class="caption">
A nail</div></div>
 <p>These three objects (a cone and two cylinders) are independent, but the Function Mechanism makes them connected to each other and representing one object &ndash; a nail. <br  />
 The object "nail" has the following parameters: <br  />
</p>
<ul>
<li>The position of the nail is defined by the apex point of the cone. The cylinders are built on the cone and therefore they depend on the position of the cone. In this way we define a dependency of the cylinders on the cone. <br  />
</li>
<li>The height of the nail is defined by the height of the cone. <br  />
 Let’s consider that the long cylinder has 3 heights of the cone and the header cylinder has a half of the height of the cone. <br  />
</li>
<li>The radius of the nail is defined by the radius of the cone. The radius of the long cylinder coincides with this value. Let’s consider that the header cylinder has one and a half radiuses of the cone. <br  />
</li>
</ul>
<p>So, the cylinders depend on the cone and the cone parameters define the size of the nail. <br  />
</p>
<p>It means that re-positioning the cone (changing its apex point) moves the nail, the change of the radius of the cone produces a thinner or thicker nail, and the change of the height of the cone shortens or prolongates the nail. <br  />
 &#160;It is suggested to examine the programming steps needed to create a 3D parametric model of the "nail". <br  />
</p>
<h1><a class="anchor" id="autotoc_md21"></a>
Step1: Data Tree</h1>
<p>The first step consists in model data allocation in the OCAF tree. In other words, it is necessary to decide where to put the data. <br  />
</p>
<p>In this case, the data can be organized into a simple tree using references for definition of dependent parameters: <br  />
</p>
<ul>
<li><p class="startli">Nail</p><ul>
<li>Cone<ul>
<li>Position (x,y,z)</li>
<li>Radius</li>
<li>Height</li>
</ul>
</li>
<li>Cylinder (stem)<ul>
<li>Position = "Cone" position translated for "Cone" height along Z;</li>
<li>Radius = "Cone" radius;</li>
<li>Height = "Cone" height multiplied by 3;</li>
</ul>
</li>
<li>Cylinder (head) <br  />
<ul>
<li>Position = "Long cylinder" position translated for "Long cylinder" height along Z;</li>
<li>Radius = "Long cylinder" radius multiplied by 1.5;</li>
<li>Height = "Cone" height divided by 2.</li>
</ul>
</li>
</ul>
<p class="startli">The "nail" object has three sub-leaves in the tree: the cone and two cylinders. <br  />
</p>
<p class="startli">The cone object is independent. <br  />
</p>
<p class="startli">The long cylinder representing a "stem" of the nail refers to the corresponding parameters of the cone to define its own data (position, radius and height). It means that the long cylinder depends on the cone. <br  />
</p>
<p class="startli">The parameters of the head cylinder may be expressed through the cone parameters only or through the cone and the long cylinder parameters. It is suggested to express the position and the radius of the head cylinder through the position and the radius of the long cylinder, and the height of the head cylinder through the height of the cone. It means that the head cylinder depends on the cone and the long cylinder. <br  />
</p>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md22"></a>
Step 2: Interfaces</h1>
<p>The interfaces of the data model are responsible for dynamic creation of the data tree of the represented at the previous step, data modification and deletion. <br  />
</p>
<p>The interface called <em>INail</em> should contain the methods for creation of the data tree for the nail, setting and getting of its parameters, computation, visualization and removal. <br  />
</p>
<h2><a class="anchor" id="autotoc_md23"></a>
Creation of the nail</h2>
<p>This method of the interface creates a data tree for the nail at a given leaf of OCAF data tree. <br  />
</p>
<p>It creates three sub-leaves for the cone and two cylinders and allocates the necessary data (references at the sub-leaves of the long and the head cylinders). <br  />
</p>
<p>It sets the default values of position, radius and height of the nail. <br  />
</p>
<p>The nail has the following user parameters: <br  />
</p><ul>
<li>The position &ndash; coincides with the position of the cone <br  />
</li>
<li>The radius of the stem part of the nail &ndash; coincides with the radius of the cone <br  />
</li>
<li>The height of the nail &ndash; a sum of heights of the cone and both cylinders <br  />
</li>
</ul>
<p>The values of the position and the radius of the nail are defined for the cone object data. The height of the cone is recomputed as 2 * heights of nail and divided by 9. <br  />
</p>
<h2><a class="anchor" id="autotoc_md24"></a>
Computation</h2>
<p>The Function Mechanism is responsible for re-computation of the nail. It will be described in detail later in this document. <br  />
</p>
<p>A data leaf consists of the reference&#160; to the location of the real data and a real value defining a coefficient of multiplication of the referenced data. <br  />
</p>
<p>For example, the height of the long cylinder is defined as a reference to the height of the cone with coefficient 3. The data leaf of the height of the long cylinder should contain two attributes: a reference to the height of cone and a real value equal to 3. <br  />
</p>
<h2><a class="anchor" id="autotoc_md25"></a>
Visualization</h2>
<p>&#160;The shape resulting of the nail function can be displayed using the standard OCAF visualization mechanism. <br  />
</p>
<h2><a class="anchor" id="autotoc_md26"></a>
Removal of the nail</h2>
<p>To automatically erase the nail from the viewer and the data tree it is enough to clean the nail leaf from attributes. <br  />
</p>
<h1><a class="anchor" id="autotoc_md27"></a>
Step 3: Functions</h1>
<p>The nail is defined by four functions: the cone, the two cylinders and the nail function. <br  />
 The function of the cone is independent. The functions of the cylinders depend on the cone function. The nail function depends on the results of all functions: <br  />
</p>
<div class="image">
<img src="ocaf_functionmechanism_wp_image005.png" alt=""/>
<div class="caption">
A graph of dependencies between functions</div></div>
 <p>Computation of the model starts with the cone function, then the long cylinder, after that the header cylinder and, finally, the result is generated by the nail function at the end of function chain. <br  />
</p>
<p>The Function Mechanism of Open CASCADE Technology creates this graph of dependencies and allows iterating it following the dependencies. The only thing the Function Mechanism requires from its user is the implementation of pure virtual methods of <em>TFunction_Driver</em>: <br  />
</p>
<ul>
<li><em>::Arguments()</em> &ndash; returns a list of arguments for the function <br  />
</li>
<li><em>::Results()</em> &ndash; returns a list of results of the function <br  />
</li>
</ul>
<p>These methods give the Function Mechanism the information on the location of arguments and results of the function and allow building a graph of functions. The class <em>TFunction_Iterator</em> iterates the functions of the graph in the execution order. <br  />
</p>
<p>The pure virtual method <em>TFunction_Driver::Execute()</em> calculating the function should be overridden. <br  />
</p>
<p>The method <em>::MustExecute()</em> calls the method <em>::Arguments()</em> of the function driver and ideally this information (knowledge of modification of arguments of the function) is enough to make a decision whether the function should be executed or not. Therefore, this method usually shouldn’t be overridden. <br  />
</p>
<p>The cone and cylinder functions differ only in geometrical construction algorithms. Other parameters are the same (position, radius and height). <br  />
</p>
<p>It means that it is possible to create a base class &ndash; function driver for the three functions, and two descendant classes producing: a cone or a cylinder. <br  />
</p>
<p>For the base function driver the methods <em>::Arguments()</em> and <em>::Results()</em> will be overridden. Two descendant function drivers responsible for creation of a cone and a cylinder will override only the method <em>::Execute()</em>.</p>
<p>The method <em>::Arguments()</em> of the function driver of the nail returns the results of the functions located under it in the tree of leaves. The method <em>::Execute()</em> just collects the results of the functions and makes one shape &ndash; a nail.</p>
<p>This way the data model using the Function Mechanism is ready for usage. Do not forget to introduce the function drivers for a function driver table with the help of <em>TFunction_DriverTable</em> class.</p>
<h2><a class="anchor" id="autotoc_md28"></a>
Example 1: iteration and execution of functions.</h2>
<p>This is an example of the code for iteration and execution of functions. <br  />
</p>
<div class="fragment"><div class="line"><span class="comment">// The scope of functions is  defined.  </span></div>
<div class="line">Handle(TFunction_Scope) scope = TFunction_Scope::Set( anyLabel );  </div>
<div class="line"> </div>
<div class="line"><span class="comment">// The information on  modifications in the model is received.  </span></div>
<div class="line">TFunction_Logbook&amp;amp; log = scope-GetLogbook();  </div>
<div class="line"> </div>
<div class="line"><span class="comment">// The iterator is iInitialized by  the scope of functions.  </span></div>
<div class="line">TFunction_Iterator iterator( anyLabel );  </div>
<div class="line">Iterator.SetUsageOfExecutionOrder( <span class="keyword">true</span> );  </div>
<div class="line"> </div>
<div class="line"><span class="comment">// The function is iterated,  its  dependency is checked on the modified data and  executed if necessary.  </span></div>
<div class="line"><span class="keywordflow">for</span> (; iterator.more(); iterator.Next())  </div>
<div class="line">{  </div>
<div class="line">  <span class="comment">// The function iterator may return a list of  current functions for execution.  </span></div>
<div class="line">  <span class="comment">// It might be useful for multi-threaded execution  of functions.  </span></div>
<div class="line">  <span class="keyword">const</span>  TDF_LabelList&amp;amp; currentFunctions = iterator.Current();  </div>
<div class="line">   </div>
<div class="line">  <span class="comment">//The list of current functions is iterated.  </span></div>
<div class="line">  TDF_ListIteratorOfLabelList  currentterator( currentFunctions );</div>
<div class="line">  <span class="keywordflow">for</span> (;  currentIterator.More(); currentIterator.Next())  </div>
<div class="line">  {  </div>
<div class="line">    <span class="comment">//  An interface for the function is created.  </span></div>
<div class="line">    TFunction_IFunction  interface( currentIterator.Value() );  </div>
<div class="line"> </div>
<div class="line">    <span class="comment">//  The function driver is retrieved.  </span></div>
<div class="line">    Handle(TFunction_Driver)  driver = interface.GetDriver();  </div>
<div class="line"> </div>
<div class="line">    <span class="comment">//  The dependency of the function on the  modified data is checked.  </span></div>
<div class="line">    If  (driver-MustExecute( log ))  </div>
<div class="line">    {  </div>
<div class="line">      <span class="comment">// The function is executed.  </span></div>
<div class="line">      <span class="keywordtype">int</span>  ret = driver-Execute( log );  </div>
<div class="line">      <span class="keywordflow">if</span> ( ret ) </div>
<div class="line">        <span class="keywordflow">return</span>  <span class="keyword">false</span>;  </div>
<div class="line">    } <span class="comment">// end if check on modification  </span></div>
<div class="line">  } <span class="comment">// end of iteration of current functions  </span></div>
<div class="line">} <span class="comment">// end of iteration of  functions.</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md29"></a>
Example 2: Cylinder function driver</h2>
<p>This is an example of the code for a cylinder function driver. To make the things clearer, the methods <em>::Arguments()</em> and <em>::Results()</em> from the base class are also mentioned. <br  />
</p>
<div class="fragment"><div class="line"><span class="comment">// A virtual method  ::Arguments() returns a list of arguments of the function.  </span></div>
<div class="line">CylinderDriver::Arguments( TDF_LabelList&amp;amp; args )  </div>
<div class="line">{  </div>
<div class="line">  <span class="comment">// The direct arguments, located at sub-leaves of  the function, are collected (see picture 2).</span></div>
<div class="line">  TDF_ChildIterator  cIterator( Label(), <span class="keyword">false</span> );  </div>
<div class="line">  <span class="keywordflow">for</span> (;  cIterator.More(); cIterator.Next() )  </div>
<div class="line">  {  </div>
<div class="line">    <span class="comment">// Direct argument.  </span></div>
<div class="line">    TDF_Label  sublabel = cIterator.Value();  </div>
<div class="line">    Args.Append(  sublabel );  </div>
<div class="line"> </div>
<div class="line">    <span class="comment">// The references to the external data are  checked.  </span></div>
<div class="line">    Handle(TDF_Reference)  ref;  </div>
<div class="line">    If (  sublabel.FindAttribute( TDF_Reference::GetID(), ref ) )  </div>
<div class="line">    {  </div>
<div class="line">      args.Append(  ref-Get() );  </div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// A virtual method ::Results()  returns a list of result leaves.  </span></div>
<div class="line">CylinderDriver::Results( TDF_LabelList&amp;amp; res )  </div>
<div class="line">{  </div>
<div class="line">  <span class="comment">// The result is kept at the function  label.  </span></div>
<div class="line">  Res.Append(  Label() );  </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Execution of the function  driver.  </span></div>
<div class="line">Int CylinderDriver::Execute( TFunction_Logbook&amp;amp; log )  </div>
<div class="line">{  </div>
<div class="line">  <span class="comment">// Position of the cylinder - position of the first  function (cone)   </span></div>
<div class="line">  <span class="comment">//is  elevated along Z for height values of all  previous functions.  </span></div>
<div class="line">  gp_Ax2 axes = …. <span class="comment">// out of the scope of this guide.  </span></div>
<div class="line">  <span class="comment">// The radius value is retrieved.  </span></div>
<div class="line">  <span class="comment">// It is located at second child sub-leaf (see the  picture 2).  </span></div>
<div class="line">  TDF_Label radiusLabel  = Label().FindChild( 2 );  </div>
<div class="line">   </div>
<div class="line">  <span class="comment">// The multiplicator of the radius ()is retrieved.  </span></div>
<div class="line">  Handle(TDataStd_Real)  radiusValue;  </div>
<div class="line">  radiusLabel.FindAttribute(  TDataStd_Real::GetID(), radiusValue);  </div>
<div class="line">   </div>
<div class="line">  <span class="comment">// The reference to the radius is retrieved.  </span></div>
<div class="line">  Handle(TDF_Reference)  refRadius;  </div>
<div class="line">  RadiusLabel.FindAttribute(  TDF_Reference::GetID(), refRadius );  </div>
<div class="line">   </div>
<div class="line">  <span class="comment">// The radius value is calculated.  </span></div>
<div class="line">  <span class="keywordtype">double</span> radius = 0.0;</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">if</span> (  refRadius.IsNull() )</div>
<div class="line">  {</div>
<div class="line">    radius  = radiusValue-Get();  </div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span>  </div>
<div class="line">  {  </div>
<div class="line">    <span class="comment">// The referenced radius value is  retrieved.   </span></div>
<div class="line">    Handle(TDataStd_Real)  referencedRadiusValue;  </div>
<div class="line">    RefRadius-Get().FindAttribute(TDataStd_Real::GetID()  ,referencedRadiusValue );  </div>
<div class="line">    radius  = referencedRadiusValue-Get() * radiusValue-Get();  </div>
<div class="line">  }  </div>
<div class="line">   </div>
<div class="line">  <span class="comment">// The height value is retrieved.  </span></div>
<div class="line">  <span class="keywordtype">double</span> height = … <span class="comment">// similar code to taking the radius value.  </span></div>
<div class="line">   </div>
<div class="line">  <span class="comment">// The cylinder is created.  </span></div>
<div class="line">  TopoDS_Shape cylinder  = BRepPrimAPI_MakeCylinder(axes, radius, height);  </div>
<div class="line">   </div>
<div class="line">  <span class="comment">// The result (cylinder) is set  </span></div>
<div class="line">  TNaming_Builder  builder( Label() );  </div>
<div class="line">  Builder.Generated(  cylinder );  </div>
<div class="line">   </div>
<div class="line">  <span class="comment">// The modification of the result leaf is saved in  the log.  </span></div>
<div class="line">  log.SetImpacted(  Label() );  </div>
<div class="line">   </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Dec 4 2023 13:54:32 for Open CASCADE Technology by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.18 </li>
  </ul>
</div>
</body>
</html>
